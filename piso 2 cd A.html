<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico Brother (Home) - V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: monospace; }
        .log-box { background: #1e293b; border: 1px solid #334155; padding: 1rem; border-radius: 0.5rem; height: 300px; overflow-y: auto; }
        .result-box { background: #422006; border: 2px solid #eab308; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; white-space: pre-wrap; word-break: break-all; color: #fef08a; }
        .success { color: #4ade80; }
        .warning { color: #facc15; }
        .error { color: #f87171; }
    </style>
</head>
<body>
    <div id="root" class="max-w-4xl mx-auto p-8"></div>

    <script type="text/babel">
        const { useState } = React;

        // RUTA CORREGIDA POR EL USUARIO
        const TARGET_URL = "http://10.1.145.148/home/status.html";

        function Debugger() {
            const [logs, setLogs] = useState([]);
            const [snippet, setSnippet] = useState(null);

            const addLog = (msg, type = "info") => {
                const time = new Date().toLocaleTimeString();
                setLogs(prev => [...prev, { time, msg, type }]);
            };

            const runDiagnosis = async () => {
                setLogs([]);
                setSnippet(null);
                addLog(`Iniciando conexión a ${TARGET_URL}...`, "info");

                try {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), 8000);
                    
                    const res = await fetch(TARGET_URL, {
                        signal: controller.signal,
                        cache: "no-store",
                        mode: "cors"
                    });
                    clearTimeout(id);

                    if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                    
                    const text = await res.text();
                    addLog(`Descarga exitosa: ${text.length} caracteres.`, "success");

                    // BÚSQUEDA DE DATOS
                    // 1. Buscamos "Magenta" (etiqueta común)
                    let idx = text.indexOf("Magenta");
                    if (idx === -1) idx = text.indexOf("magenta"); // minúsculas
                    
                    // 2. Si no está, buscamos "ink_level" o similar
                    if (idx === -1) idx = text.indexOf("ink_level");
                    
                    // 3. Si no está, buscamos "height"
                    if (idx === -1) idx = text.indexOf("height");

                    if (idx !== -1) {
                        addLog(`¡Pista encontrada en posición ${idx}!`, "success");
                        // Extraer contexto
                        const start = Math.max(0, idx - 400);
                        const end = Math.min(text.length, idx + 600);
                        const extracted = text.substring(start, end);
                        setSnippet(extracted);
                        addLog("Mostrando código fuente real abajo...", "warning");
                    } else {
                         addLog("No se encontraron palabras clave obvias. Mostrando inicio del HTML...", "error");
                         setSnippet(text.substring(0, 1000));
                    }

                } catch (err) {
                    addLog(`Error: ${err.message}`, "error");
                    if (err.message.includes("Failed to fetch")) {
                        addLog("Verifica la extensión CORS.", "warning");
                    }
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h1 className="text-2xl font-bold text-blue-400">Rastreador Brother (Ruta Home)</h1>
                        <button 
                            onClick={runDiagnosis}
                            className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold transition-colors"
                        >
                            Escanear
                        </button>
                    </div>

                    <div className="log-box font-mono text-sm">
                        {logs.map((l, i) => (
                            <div key={i} className="mb-1">
                                <span className="text-slate-500 mr-2">[{l.time}]</span>
                                <span className={l.type}>{l.msg}</span>
                            </div>
                        ))}
                    </div>

                    {snippet && (
                        <div>
                            <h3 className="text-xl font-bold mb-2 text-yellow-400">Zona de Interés Detectada:</h3>
                            <div className="result-box">
                                {snippet.replace(/</g, "&lt;").replace(/>/g, "&gt;")}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Debugger />);
    </script>
</body>
</html>